{% extends "base.html" %}

{% block title %}Resultados - Kruskal{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.9/dist/dist/vis-network.min.css">
<style>
    :root {
        --kruskal-primary: #10b981;
        --kruskal-secondary: #34d399;
        --kruskal-light: #d1fae5;
        --kruskal-dark: #047857;
    }
    
    .kruskal-theme {
        background: linear-gradient(135deg, var(--kruskal-primary) 0%, var(--kruskal-secondary) 100%);
    }
    
    .badge-kruskal {
        background: var(--kruskal-primary);
        color: white;
    }
    
    #graphContainer, #mstContainer {
        width: 100%;
        height: 450px;
        border: 2px solid var(--kruskal-light);
        border-radius: 10px;
        background: #f8f9fa;
    }
    
    .iteration-table th {
        background: var(--kruskal-light);
        color: var(--kruskal-dark);
        font-weight: 600;
    }
    
    .edge-accepted {
        background-color: #d1fae5 !important;
        font-weight: bold;
    }
    
    .edge-rejected {
        background-color: #fee2e2 !important;
    }
    
    .mst-edge {
        background-color: #bfdbfe !important;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="py-4 mb-4" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-bottom: 4px solid #10b981;">
    <div class="container">
        <h1 class="display-5 fw-bold mb-2" style="color: #047857;">
            <i class="fas fa-check-circle me-3" style="color: #10b981;"></i>Resultados - Kruskal
        </h1>
        <p class="lead mb-0" style="color: #047857;">Árbol de Expansión Mínima encontrado</p>
    </div>
</div>

<div class="container mb-5">
    {% if result.success %}
        
        <!-- Resultado Principal -->
        <div class="alert alert-success mb-4">
            <h4 class="mb-3"><i class="fas fa-project-diagram me-2"></i>Árbol de Expansión Mínima (MST)</h4>
            <div class="row">
                <div class="col-md-4">
                    <p class="mb-2">
                        <strong>Nodos en el Grafo:</strong> 
                        <span class="badge bg-primary fs-5">{{ result.num_nodes }}</span>
                    </p>
                </div>
                <div class="col-md-4">
                    <p class="mb-2">
                        <strong>Aristas en el MST:</strong> 
                        <span class="badge bg-success fs-5">{{ result.num_edges }}</span>
                    </p>
                </div>
                <div class="col-md-4">
                    <p class="mb-2">
                        <strong>Peso Total:</strong> 
                        <span class="badge badge-kruskal fs-5">{{ result.total_weight }}</span>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Visualización del MST -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-white">
                <h4 class="mb-0">
                    <i class="fas fa-sitemap me-2" style="color: #10b981;"></i>
                    Árbol de Expansión Mínima (MST)
                </h4>
            </div>
            <div class="card-body">
                <div id="mstContainer"></div>
                <div class="mt-3">
                    <span class="badge bg-success me-2">
                        <i class="fas fa-minus me-1"></i>Aristas en el MST
                    </span>
                    <span class="badge bg-secondary">
                        <i class="fas fa-circle me-1"></i>Nodos conectados
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Aristas del MST -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-white">
                <h4 class="mb-0">
                    <i class="fas fa-list me-2" style="color: #10b981;"></i>
                    Aristas Seleccionadas para el MST
                </h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nodo 1</th>
                                <th>Nodo 2</th>
                                <th>Peso</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u, v, w in result.mst_edges %}
                            <tr class="mst-edge">
                                <td>{{ loop.index }}</td>
                                <td><strong>{{ u }}</strong></td>
                                <td><strong>{{ v }}</strong></td>
                                <td><span class="badge bg-success">{{ w }}</span></td>
                            </tr>
                            {% endfor %}
                            <tr class="table-info">
                                <td colspan="3" class="text-end"><strong>Peso Total del MST:</strong></td>
                                <td><strong><span class="badge badge-kruskal fs-5">{{ result.total_weight }}</span></strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Grafo Original -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-white">
                <h4 class="mb-0">
                    <i class="fas fa-project-diagram me-2" style="color: #10b981;"></i>
                    Grafo Original Completo
                </h4>
            </div>
            <div class="card-body">
                <div id="graphContainer"></div>
                <div class="mt-3">
                    <p class="text-muted mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Este es el grafo completo de entrada. El algoritmo seleccionó las aristas que minimizan el peso total.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Iteraciones del Algoritmo -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-white">
                <h4 class="mb-0">
                    <i class="fas fa-list-ol me-2" style="color: #10b981;"></i>
                    Proceso del Algoritmo de Kruskal
                </h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Proceso:</strong> Las aristas se ordenan por peso y se evalúan en orden ascendente. 
                    Se aceptan si no forman ciclos, se rechazan si ya conectan nodos en el mismo componente.
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered iteration-table">
                        <thead>
                            <tr>
                                <th>Iteración</th>
                                <th>Arista</th>
                                <th>Peso</th>
                                <th>Decisión</th>
                                <th>Razón</th>
                                <th>Aristas en MST</th>
                                <th>Peso Acumulado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for iter in result.iterations %}
                            <tr class="{% if iter.accepted %}edge-accepted{% else %}edge-rejected{% endif %}">
                                <td><strong>{{ iter.iteration }}</strong></td>
                                <td>
                                    <span class="badge bg-secondary">{{ iter.edge[0] }}</span>
                                    <i class="fas fa-arrows-alt-h mx-1"></i>
                                    <span class="badge bg-secondary">{{ iter.edge[1] }}</span>
                                </td>
                                <td><span class="badge bg-info">{{ iter.weight }}</span></td>
                                <td>
                                    {% if iter.accepted %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>ACEPTADA
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times me-1"></i>RECHAZADA
                                        </span>
                                    {% endif %}
                                </td>
                                <td><small>{{ iter.reason }}</small></td>
                                <td><span class="badge bg-primary">{{ iter.num_edges_in_mst }}</span></td>
                                <td>
                                    {% if iter.accepted %}
                                        <span class="badge bg-success">{{ iter.total_weight }}</span>
                                    {% else %}
                                        <span class="text-muted">{{ iter.total_weight }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Aristas Ordenadas -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-white">
                <h4 class="mb-0">
                    <i class="fas fa-sort-amount-up me-2" style="color: #10b981;"></i>
                    Todas las Aristas Ordenadas por Peso
                </h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Arista</th>
                                <th>Peso</th>
                                <th>Estado en MST</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u, v, w in result.sorted_edges %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ u }} - {{ v }}</td>
                                <td>{{ w }}</td>
                                <td>
                                    {% if (u, v, w) in result.mst_edges or (v, u, w) in result.mst_edges %}
                                        <span class="badge bg-success">En MST</span>
                                    {% else %}
                                        <span class="badge bg-secondary">No incluida</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Botones de Acción -->
        <div class="text-center">
            <button onclick="window.print()" class="btn btn-outline-secondary btn-lg me-2">
                <i class="fas fa-print me-2"></i>Imprimir
            </button>
            <a href="{{ url_for('kruskal_method') }}" class="btn btn-outline-primary btn-lg">
                <i class="fas fa-redo me-2"></i>Nuevo Problema
            </a>
        </div>
        
    {% else %}
        <!-- Error -->
        <div class="alert alert-danger">
            <h4><i class="fas fa-exclamation-triangle me-2"></i>Error</h4>
            <p class="mb-0">{{ result.error }}</p>
        </div>
        <div class="text-center mt-4">
            <a href="{{ url_for('kruskal_method') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-arrow-left me-2"></i>Volver
            </a>
        </div>
    {% endif %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.9/dist/vis-network.min.js"></script>
<script>
    {% if result.success %}
    // Configuración común
    const commonOptions = {
        nodes: {
            shape: 'circle',
            size: 30,
            borderWidth: 2,
            borderWidthSelected: 4,
            shadow: true,
            font: { color: 'white', size: 16, bold: true }
        },
        edges: {
            smooth: {
                type: 'continuous',
                roundness: 0.5
            },
            shadow: true
        },
        physics: {
            enabled: true,
            stabilization: {
                iterations: 200
            },
            barnesHut: {
                gravitationalConstant: -2000,
                springLength: 150,
                springConstant: 0.04
            }
        },
        interaction: {
            hover: true,
            tooltipDelay: 200,
            zoomView: true,
            dragView: true
        }
    };
    
    // Visualización del MST
    const mstData = {{ result.mst_graph_data | tojson }};
    const mstNodes = new vis.DataSet(mstData.nodes.map(node => ({
        id: node.id,
        label: node.label,
        color: '#10b981'
    })));
    
    const mstEdges = new vis.DataSet(mstData.edges.map(edge => ({
        from: edge.from,
        to: edge.to,
        label: edge.label,
        color: { color: '#10b981', highlight: '#047857' },
        width: 4,
        font: { size: 14, color: '#047857', strokeWidth: 0, bold: true }
    })));
    
    const mstContainer = document.getElementById('mstContainer');
    const mstNetwork = new vis.Network(mstContainer, 
        { nodes: mstNodes, edges: mstEdges }, 
        commonOptions
    );
    
    mstNetwork.once('stabilizationIterationsDone', function() {
        mstNetwork.fit({
            animation: {
                duration: 1000,
                easingFunction: 'easeInOutQuad'
            }
        });
    });
    
    // Visualización del grafo original
    const graphData = {{ result.graph_data | tojson }};
    const graphNodes = new vis.DataSet(graphData.nodes.map(node => ({
        id: node.id,
        label: node.label,
        color: '#94a3b8'
    })));
    
    const graphEdges = new vis.DataSet(graphData.edges.map(edge => ({
        from: edge.from,
        to: edge.to,
        label: edge.label,
        color: { color: '#cbd5e1' },
        width: 2,
        font: { size: 14, color: '#64748b', strokeWidth: 0 }
    })));
    
    const graphContainer = document.getElementById('graphContainer');
    const graphNetwork = new vis.Network(graphContainer, 
        { nodes: graphNodes, edges: graphEdges }, 
        commonOptions
    );
    
    graphNetwork.once('stabilizationIterationsDone', function() {
        graphNetwork.fit({
            animation: {
                duration: 1000,
                easingFunction: 'easeInOutQuad'
            }
        });
    });
    {% endif %}
</script>
{% endblock %}
